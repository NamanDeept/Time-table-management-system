YUI.add("hermes-template-album-engagement",function(e,a){var n=e.Template.Handlebars.revive({1:function(e,a,n,l,t){return'\t<div class="create-book-container">\n\t\t<span class="create-book-icon" title="'+e.escapeExpression((n.intlMessage||a&&a.intlMessage||n.helperMissing).call(null!=a?a:{},{name:"intlMessage",hash:{intlName:"album-page.CREATE_BOOK_FROM_ALBUM"},data:t}))+'"></span>\n\t</div>\n'},3:function(e,a,n,l,t){return'\t<div class="download-album-container">\n\t\t<span class="download-album-icon"></span>\n\t</div>\n'},compiler:[7,">= 4.0.0"],main:function(e,a,n,l,t){var s,r=null!=a?a:{};return e.escapeExpression((n.outlet||a&&a.outlet||n.helperMissing).call(r,null!=a?a["fluid-share-album-view"]:a,{name:"outlet",hash:{},data:t}))+"\n\n"+(null!=(s=n.if.call(r,null!=a?a.viewerIsOwner:a,{name:"if",hash:{},fn:e.program(1,t,0),inverse:e.noop,data:t}))?s:"")+"\n\n"+(null!=(s=n.if.call(r,null!=a?a.enableDownload:a,{name:"if",hash:{},fn:e.program(3,t,0),inverse:e.noop,data:t}))?s:"")},useData:!0}),l={};e.Array.each([],function(a){var n=e.Template.get("hermes/"+a);n&&(l[a]=n)}),e.Template.register("hermes/album-engagement",function(a,t){return t=t||{},t.partials=t.partials?e.merge(l,t.partials):l,n(a,t)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("album-engagement-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.albumId=e.albumId,this.albumPhotoListLayoutStyle=e.albumPhotoListLayoutStyle,""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this.doOffline=!!this.appContext.flipper.isFlipped("enable-offline-downloadr"),this},subviewConfig:{"fluid-share-album-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1,parentViewName:this.name}},loadState:function(){var e=this;return e.appContext.getModel("set-models",e.albumId).then(function(t){e.set("albumModel",t)})},createBookFromAlbum:function(){this.appContext.flapp.navigate("/create")},buildContainer:function(){var e=this.get("container"),t=this.get("albumModel"),i=!1,n={};return"justified"===this.albumPhotoListLayoutStyle&&e.addClass("justified"),this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid===t.getValue("owner").id&&(i=!0),n.viewerIsOwner=i,n.enableDownload=!1,(this.appContext.flipper.isFlipped("enable-just-your-album-download")&&i||this.appContext.flipper.isFlipped("enable-album-download")&&t.getValue("canDownload"))&&(n.enableDownload=!0),this.subviews["fluid-share-album-view"]&&(n["fluid-share-album-view"]=this.subviews["fluid-share-album-view"].get("container"),(n.viewerIsOwner||n["enable-download"])&&n["fluid-share-album-view"].addClass("not-alone")),this.setContainerWithTemplate("album-engagement",n),this},buildErrorContainer:function(){},activate:function(){var t=this,i=this.get("container"),n=i.one(".create-book-container"),o=i.one(".download-album-container");return n&&t.registerEventHandler(n.on("click",function(){t.createBookFromAlbum()})),o&&(this.bulkDownloaderView=new e.BulkDownloaderView({appContext:this.appContext,doOffline:this.doOffline}),t.registerEventHandler(o.on("click",t.downloadAlbum.bind(this)))),this},destructor:function(){this.bulkDownloaderView&&this.bulkDownloaderView.destroy()},downloadAlbum:function(t){var i,n,o=this,a=this.get("albumModel");if(e.rapidTracker.beacon(this.name,"openDownloadAlbum"),this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid===a.getValue("owner").id&&this.bulkDownloaderView.set("isOwnAlbum",!0),this.doOffline){if(1===a.getValue("totalCount"))return a.getValue("photoPageList").getPage({page:1,perPage:1}).then(function(t){var i,n,a,l=t[0];l.getValue("isVideo")&&!o.appContext.flipper.isFlipped("disable-video-playback")?n="/video_download.gne?id="+l.id:(i=(a=l.getLargestSize({excludeSizes:[]}).url.split(".")).pop(),0===(n=a.join(".")+"_d."+i).indexOf("//")&&(n="https:"+n)),e.config.doc.location.href=n});if(a.getValue("totalCount")>e.config.flickr.downloadr.max_album_items)return e.rapidTracker.beacon(this.name,"albumDownloadTooMany"),this.onError(this.intlMessage({intlName:this.bulkDownloaderView.get("isOwnAlbum")?"downloadr.ALBUM_TOO_MANY_OWN":"downloadr.ALBUM_TOO_MANY_OTHER",username:a.getValue("owner").getValue("displayname"),userurl:a.getValue("owner").getValue("url"),url:"/photos/organize?start_tab=one_set"+a.id}),this.intlMessage({intlName:"downloadr.TOO_MANY_TITLE"}),!0);i=o.bulkDownloaderView.createTitle(a.getValue("photoCount"),a.getValue("videoCount")),o.bulkDownloaderView.showDownloadDialog({doOffline:!0,title:i,setID:this.albumId})}else n=this.bulkDownloaderView.showLoadingDialog(),this.bulkDownloaderView.prepareArchive({set_id:this.albumId}).then(function(e){n.close(),o.bulkDownloaderView.showDownloadDialog(e)}).catch(function(e){n.close(),o.onError(e)})},onParentViewEvent:function(e,t){var i=this.get("container");return"album-engagement-view"===e&&"albumHeaderView:editing"===t[0]?(i.addClass("invisible"),!1):"album-engagement-view"===e&&"albumHeaderView:doneEditing"===t[0]?(i.removeClass("invisible"),!1):void 0},onError:function(t,i,n){var o;return o={appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,showCancelButton:!1,title:this.intlMessage({intlName:"common.OOPS"}),actionButtonLabel:this.intlMessage({intlName:"common.OK"}),darkOverlay:!0},o[n?"htmlMessage":"message"]=t,this.errorDialog=new e.Views.FluidModal(o),this.errorDialog.show(),this.errorDialog}})},"@VERSION@",{requires:["flickr-view","hermes-template-album-engagement","hermes-template-flickr-balls"],optionalRequires:["bulk-downloader-view"],optional:["fluid-share-album-view"],langBundles:["common","album-page","downloadr"]});YUI.add("album-header-view",function(e,t){var i=require("hermes-core/flog")(t),a={css:{headerContent:".album-header-content"}};e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.albumId=e.albumId,this.albumPhotoListLayoutStyle=e.albumPhotoListLayoutStyle,""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this},subviewConfig:{"album-title-desc-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"album-stats-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"album-engagement-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"attribution-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0,hideFollowView:!0,additionalViewClasses:["album-attribution"],isAlbumView:!0}},loadState:function(){var t=this,i=[];return i.push(this.appContext.getModel("set-models",this.albumId)),this.appContext.getViewer().signedIn&&i.push(this.appContext.getModel("person-preferences-models",this.appContext.getViewer().nsid)),e.Promise.all(i).then(function(e){t.set("albumModel",e[0]),e[1]&&t.set("personPreferenceModel",e[1])})},buildContainer:function(){var e,t=this.get("container"),a=this.getAlbumHeaderHeight()-60,n=this.get("albumModel"),o=this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid===n.getValue("owner").id,s=this.appContext.viewportData.getDevicePixelRatio(),l=n.getValue("totalCount")<500;return"justified"===this.albumPhotoListLayoutStyle&&(t.addClass("justified-transitions"),t.addClass("justified"),a=300),(e=n.registry.getSizeToFit(this.albumId,{width:.8*this.appContext.viewportData.getWidth()*s,height:a*s}))||i.error("Failed to load album coverphoto."),this.setContainerWithTemplate("album-header",{height:a,"cover-photo-url":e?e.url:"",viewerIsOwner:o,sortEnabled:l}),this},buildErrorContainer:function(){},activate:function(){var t,i=this,n=this.get("container"),o=n.one(".edit-cover-photo"),s=n.one(".album-header-content"),l=n.one(".avatar"),r=this.get("personPreferenceModel");if(this.albumHeaderElement=this.get("container").one(a.css.headerContent),this.registerEventHandler(e.globalEvents.subscribe("window:resize",this.resizeHeader.bind(this))),o&&this.registerEventHandler(o.on("click",this.handleSetCoverPhotoClick.bind(this))),this.appContext.flipper.isFlipped("enable-change-album-sorting")){var d=this.get("container").one(".change-album-sorting");d&&this.registerEventHandler(d.on("click",this.handleChangeAlbumSorting.bind(this)))}e.on("albumToolbarView:layoutChange",function(a){r&&(r.setValues({albumViewLayoutPref:a}),r.remoteUpdate()),"justified"===a?(n.addClass("justified-transitions"),n.addClass("justified"),s.setStyle("height",300),l&&e.flutil.onTransitionEnd(l,function(){n.one(".album-attribution").addClass("justified-album-details-page")})):(t=i.getAlbumHeaderHeight()-60+"px",s.setStyle("height",t),n.removeClass("justified"),l&&setTimeout(function(){n.one(".album-attribution").removeClass("justified-album-details-page")},250),e.flutil.onTransitionEnd(s,function(){n.removeClass("justified-transitions")}))})},onSubviewEvent:function(e,t){var i=this.get("container"),a=i.one(".album-header-content"),n=i.one(".edit-cover-photo");return"album-title-desc-view"===e&&"albumTitleDesc:editing"===t[0]?(this.fire("parentViewEvent","albumHeaderView:editing"),n.addClass("hidden"),!1):"album-title-desc-view"===e&&"albumTitleDesc:doneEditing"===t[0]?(this.fire("parentViewEvent","albumHeaderView:doneEditing"),n.removeClass("hidden"),!1):void("album-title-desc-view"===e&&"albumTitleDescEditing:heightChange"===t[0]&&t[1]&&a.setStyle("height",parseInt(a.getComputedStyle("height"),10)+t[1]+"px"))},resizeHeader:function(e){var t=this.getAlbumHeaderHeight()-60;this.get("container").hasClass("justified")||this.albumHeaderElement.setStyle("height",t)},getAlbumHeaderHeight:function(){var e,t=this.appContext.viewportData.getWidth(),i=this.appContext.viewportData.getHeight()-50,a=t/2.3+120,n=t/2.75;return e=i>t/1.3+120?t/1.3:i>a?i-120:i>n?i-120+120*(i-a)/(n-a):i,Math.max(480,Math.round(e))},handleChangeAlbumSorting:function(t){if(this.appContext.flipper.isFlipped("enable-change-album-sorting")){t.halt();var i=this;if(this.get("albumModel").getValue("totalCount")>500)return i.sortUnavailable=new e.Views.FluidModal({appContext:this.appContext,title:i.intlMessage({intlName:"common.OOPS"}),message:"Sorting is limited to 500 photos",showCancelButton:!1}),void i.sortUnavailable.show();this.sortingOptionsDialog=new e.Views.FluidDroparound({appContext:this.appContext,showDropArrow:!0,observePageResize:!0,anchorElement:t.target,minVerticalSpace:250,positionFixed:!0,anchorOffsetHorizontal:14,menuItems:[{text:this.intlMessage({intlName:"album-page.SORT_DATE_TAKEN_OLDEST"}),value:"date-posted-asc"},{text:this.intlMessage({intlName:"album-page.SORT_DATE_TAKEN_NEWEST"}),value:"date-posted-desc"},{text:this.intlMessage({intlName:"album-page.SORT_DATE_UPLOADED_OLDEST"}),value:"date-taken-asc"},{text:this.intlMessage({intlName:"album-page.SORT_DATE_UPLOADED_NEWEST"}),value:"date-taken-desc"},{text:this.intlMessage({intlName:"album-page.SORT_ALPHABETICALLY"}),value:"title"},{text:this.intlMessage({intlName:"album-page.SORT_RANDOMLY"}),value:"random"},{text:this.intlMessage({intlName:"album-page.SORT_REVERSE"}),value:"reverse"}]}),this.registerEventHandler(this.sortingOptionsDialog.on("selected",function(t){if(t.preventDefault(),i.sortingOptionsDialog.close(),t.menuItem&&t.menuItem.value){var a={photoset_id:i.get("albumModel").getValue("id"),sort:t.menuItem.value,preview:0};i.loadingModal=new e.Views.FluidModal({appContext:this.appContext,title:i.intlMessage({intlName:"common.LOADING"}),message:i.intlMessage({intlName:"album-page.SORT_ALMOST_DONE"}),showButtons:!1}),i.loadingModal.show(),i.appContext.callAPI("flickr.photosets.sortPhotos",a).then(i.onAlbumSortingChanged.bind(i)).catch(i.onAlbumSortingFailed.bind(i))}})),this.sortingOptionsDialog.show()}},onAlbumSortingChanged:function(t){"ok"===t.stat?e.config.win.location.reload():this.onAlbumSortingFailed(t)},onAlbumSortingFailed:function(t){if("fail"===t.stat){new e.Views.FluidModal({appContext:this.appContext,title:this.intlMessage({intlName:"common.ERROR"}),message:"Error while changing sort",actionButtonLabel:this.intlMessage({intlName:"common.OK"}),showCancelButton:!1}).show()}},handleSetCoverPhotoClick:function(t){t.preventDefault();var i,a,n,o=this.get("container"),s=this,l=this.get("albumModel"),r=this.templates("flickr-balls")({}),d=o.one(".edit-cover-photo"),h=this.appContext.viewportData.getDevicePixelRatio(),u=[{id:"photostream",name:this.intlMessage({intlName:"common.PHOTOSTREAM"}),value:"photostream"},{id:"sets",name:this.intlMessage({intlName:"common.ALBUMS"}),value:"sets",selected:!0},{id:"upload",name:this.intlMessage({intlName:"global-nav.UPLOAD"}),value:"upload"}],m=[{id:"photostream",name:this.intlMessage({intlName:"common.PHOTOSTREAM"}),value:"photostream"},{id:"sets",name:this.intlMessage({intlName:"common.ALBUMS"}),value:"sets",selected:!0}];(i=new e.Views.FluidModal({appContext:s.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,showBodyLines:!0,showCancelButton:!1,showCancelX:!0,title:"",navBarView:new e.Views["fluid-modal-nav-bar-view"]({appContext:s.appContext,links:[{id:"photostream",name:this.intlMessage({intlName:"common.PHOTOSTREAM"}),value:"photostream"},{id:"sets",name:this.intlMessage({intlName:"common.ALBUMS"}),value:"sets",selected:!0},{id:"upload",name:this.intlMessage({intlName:"global-nav.UPLOAD"}),value:"upload"}],enableSearch:!0,breakpointConfig:[{maxWidth:700,links:u,enableSearch:!1},{maxWidth:500,links:m,enableSearch:!1}]}),actionButtonLabel:this.intlMessage({intlName:"common.SELECT"}),actionButtonDisabled:!0,subview:new e.Views["photo-selector-view"]({appContext:this.appContext,searchable:{yours:!0,contacts:!1,everyone:!1,marketplace:!1},defaultSelected:{id:s.albumId,title:s.get("albumModel").getValue("title"),type:"set"}}),width:752,height:498,fullWindow:!0,classList:"photo-selector",hideModalOverlay:!1})).on("actionClick",function(t){d.replace(r);var u=i.get("subview").get("selected");this.appContext.getModel("photo-models",u).then(function(e){return(n=!1===l.hasPhoto(u)?l.registry.remote.addPhoto({setID:s.albumId,photoID:u},s.appContext).then(function(){return s.fire("subviewViewEvent","newPhotoAddedToAlbum",u),l.registry.remote.setPrimaryPhoto({photoId:u,albumId:s.albumId},s.appContext)}):l.registry.remote.setPrimaryPhoto({photoId:u,albumId:s.albumId},s.appContext)).then(function(t){a=e.getSizeToFit({width:.8*s.appContext.viewportData.getWidth()*h,height:(s.getAlbumHeaderHeight()-60)*h}),l.setValue("primary",e.id),l.setValue("primaryPhotoSizes",e.getValue("sizesForAlbum")),l.setValue("primaryNeedsInterstitial",e.getValue("needsInterstitial")),a&&o.one(".album-header-content").setStyle("background-image","url("+a.url+")"),o.one(".balls").replace(d)})}).then(null,function(t){new e.Views.FluidModal({title:s.intlMessage({intlName:"common.ERROR"}),actionButtonLabel:s.intlMessage({intlName:"common.OK"}),textMessage:s.intlMessage({intlName:"album-page.ERROR_COVER_PHOTO"}),appContext:s.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,actionButtonDisabled:!1,showCancelButton:!1,hideModalOverlay:!1,showCancelX:!0}).show(),o.one(".balls").replace(d)})}),i.registerEventHandler(e.on("photoSelector:selected",function(e){i.enableActionButton()})),i.registerEventHandler(e.on("photoSelector:unselected",function(e){i.disableActionButton()})),e.rapidTracker.beacon(s.name,"albumCoverPhotoEdit"),i.show()}})},"@VERSION@",{requires:["flickr-view","hermes-template-album-header","hermes-template-flickr-balls"],optional:["album-title-desc-view","album-stats-view","album-engagement-view","photo-selector-view","fluid-modal-nav-bar-view","photo-list-photo-interaction-view","attribution-view"],langBundles:["album-page","global-nav","common"]});YUI.add("album-page-view",function(e,t){var i=require("hermes-core/flog")(t);e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.albumId=e.albumId,this.isOwner=e.isOwner,this.isTwitterbot=e.isTwitterbot,this.albumPhotoListLayoutStyle=e.albumPhotoListLayoutStyle,e.id=e.albumId,e.modelRegistryName="set-models",e.maxNumAttrName="totalCount",this.pageParams=e.pageParams,e.photoListConfig={modelParams:{registryName:"set-models",modelIdOrAttributes:e.albumId,collectionAttributeName:"photoPageList"},parentName:this.name,pageParams:e.pageParams,contextSuffix:"album-"+e.albumId,measureAFT:!0,maintainScrollPosition:!1,scrollToWithId:e.withPhotoId},e.photoListConfig.layout={targetRowHeight:"justified"===this.albumPhotoListLayoutStyle?190:430,fullWidthBreakoutRowCadence:"justified"===this.albumPhotoListLayoutStyle?null:3,awakeBoundsToViewportSizeRatio:5,containerPadding:{top:4,right:0,bottom:4,left:0},itemSpacing:{horizontal:4,vertical:4}},this},subviewConfig:{"global-nav-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0},"album-toolbar-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"album-header-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"photo-list-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"pagination-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0,disabled:function(){return!this.pageParams.viewPageSize}},"signup-footer-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1},"footer-full-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!0}},loadState:function(){var e=this;return this.appContext.getModel("set-models",this.albumId).then(function(t){e.set("albumModel",t)})},buildContainer:function(){return this.setContainerWithTemplate("album-page"),this},buildHeadContainer:function(){var t,a,o,r,l=this.get("albumModel"),s=l.getValue("photoPageList").getList(),n="summary_large_image",u=[],h=(this.pageParams.nominalPage-1)*this.pageParams.viewPageSizeForShare||0;if(this.isTwitterbot&&s.length-h>=4)for(n="gallery",o=0;o<Math.min(s.length-h,4);o++)if(s[h+o]){var m=s[h+o].getSizeToFit({width:640,height:640});m&&m.url&&u.push({property:"twitter:image"+o,content:m.url})}else i.error("Missing album photo in album list",{index:h+o});l.registry?t=l.registry.getSizeToFit(this.albumId,{width:640,height:640}):i.error("Missing album model registry"),r=l.getValue("url").replace(/\/albums\/([0-9]+)/i,"/sets/$1"),a=this.templates("dynamic-page-head")({title:l.getValue("title"),description:l.getValue("description")||this.intlMessage({intlName:"album-page.OPENGRAPH_DESCRIPTION",owner:l.getValue("owner").getValue("displayname")}),url:l.getValue("url"),fullURL:e.url(r),openGraphImageURL:t?e.URLHelper.addProtocolToURL(t.url):"",openGraphaImageWidth:t?t.width:"",openGraphaImageHeight:t?t.height:"",ownerURL:l.getValue("owner").getValue("url"),twitterCardType:n,twitterImages:u,ogType:"article",domain:e.url(),feeds:[{title:this.intlMessage({intlName:"meta.ALBUM_ATOM_TITLE",username:l.getValue("owner").getValue("displayname"),albumTitle:l.getValue("title")}),url:"/services/feeds/photoset.gne?nsid="+l.getValue("owner").getValue("nsid")+"&set="+l.getValue("id")+"&lang="+this.appContext.lang.toLowerCase()+"&format=atom"}]}),a+=this.templates("head-meta")({isName:!0,metaName:"robots",metaValue:"noarchive"}),a+=this.templates("head-meta")({isName:!0,metaName:"viewport",metaValue:"width=device-width, viewport-fit=cover, initial-scale=1, maximum-scale=1"}),a+=this.templates("head-meta")({isName:!0,metaName:"googlebot",metaValue:"noarchive"}),YUI.Env.isServer?this.set("headContainer",a):(this.set("headContainer",a.concat(this.subviews["pagination-view"].get("headContainer"))),this.updateHead())},activate:function(){var t=this,i=this.get("albumModel"),a=i.getValue("isOwner");return e.later(100,this,function(){e.use("photo-page-scrappy-view")}),e.on("albumToolbarView:layoutChange",function(e){var i=t.subviews["photo-list-view"],a=i.photoListLayout;a.targetRowHeight="justified"===e?190:430,a.fullWidthBreakoutRowCadence="justified"===e?null:3,i.setItems(t.get("albumModel").getValue("photoPageList").getList())}),a||this.appContext.getViewCounter().recordAlbumView({albumOwnerID:i.getValue("owner").getValue("id"),albumID:i.getValue("id"),referrer:this.appContext.getReferrer()}),this},onSubviewEvent:function(e,t){t&&"newPhotoAddedToAlbum"===t[0]&&this.subviews["photo-list-view"].setItems(this.get("albumModel").getValue("photoPageList").getList())},getTrackingSegments:function(){return{couldHaveSeenAd:!this.get("albumModel").getValue("owner").getValue("isPro")&&!this.appContext.getViewer().isPro,vwrOwner:this.isOwner?1:0}}},{ATTRS:{spaceid:{value:792600538}}})},"@VERSION@",{requires:["flutil","flickr-view","flickr-promise","set-models","hermes-template-album-page","hermes-template-dynamic-page-head","hermes-template-head-meta","hermes-template-head-link","album-toolbar-view","album-header-view","photo-list-view","footer-full-view","url-helper"],langBundles:["album-page","meta"]});