YUI.add("hermes-template-photo-note-read-mode",function(a,e){var t=a.Template.Handlebars.revive({1:function(a,e,t,n,l){var r,s=null!=e?e:{},o=t.helperMissing,u=a.escapeExpression;return'\t\t\t<span class="author">'+u("function"==typeof(r=null!=(r=t.authorName||(null!=e?e.authorName:e))?r:o)?r.call(s,{name:"authorName",hash:{},data:l}):r)+" ("+u((t.intlMessage||e&&e.intlMessage||o).call(s,{name:"intlMessage",hash:{intlName:"common.DELETED_USER"},data:l}))+")</span><br>\n"},3:function(a,e,t,n,l){var r,s,o=null!=e?e:{},u=t.helperMissing,h=a.escapeExpression;return'\t\t\t<a href="'+h("function"==typeof(s=null!=(s=t.authorURL||(null!=e?e.authorURL:e))?s:u)?s.call(o,{name:"authorURL",hash:{},data:l}):s)+'" class="author">'+h("function"==typeof(s=null!=(s=t.authorName||(null!=e?e.authorName:e))?s:u)?s.call(o,{name:"authorName",hash:{},data:l}):s)+"</a>"+(null!=(r=t.if.call(o,null!=e?e.authorIsPro:e,{name:"if",hash:{},fn:a.program(4,l,0),inverse:a.noop,data:l}))?r:"")+"<br>\n"},4:function(a,e,t,n,l){var r;return null!=(r=a.invokePartial(n["pro-badge"],e,{name:"pro-badge",hash:{badgeType:null!=e?e.authorProBadge:e},data:l,helpers:t,partials:n,decorators:a.decorators}))?r:""},compiler:[7,">= 4.0.0"],main:function(a,e,t,n,l){var r,s,o=null!=e?e:{},u=t.helperMissing,h=a.escapeExpression;return'<div class="note-text" style="z-index:'+h("function"==typeof(s=null!=(s=t.z||(null!=e?e.z:e))?s:u)?s.call(o,{name:"z",hash:{},data:l}):s)+';">\n\t<div class="text-alignment-fix hyphenate" style="left:'+h("function"==typeof(s=null!=(s=t.x||(null!=e?e.x:e))?s:u)?s.call(o,{name:"x",hash:{},data:l}):s)+"px;top:"+h("function"==typeof(s=null!=(s=t.y||(null!=e?e.y:e))?s:u)?s.call(o,{name:"y",hash:{},data:l}):s)+'px">\n'+(null!=(r=t.if.call(o,null!=e?e.authorIsDeleted:e,{name:"if",hash:{},fn:a.program(1,l,0),inverse:a.program(3,l,0),data:l}))?r:"")+"\t\t"+h((t.renderTrustedMarkup||e&&e.renderTrustedMarkup||u).call(o,null!=e?e.text:e,{name:"renderTrustedMarkup",hash:{},data:l}))+"\n\t</div>\n</div>\n"},usePartial:!0,useData:!0}),n={};a.Array.each(["pro-badge"],function(e){var t=a.Template.get("hermes/"+e);t&&(n[e]=t)}),a.Template.register("hermes/photo-note-read-mode",function(e,l){return l=l||{},l.partials=l.partials?a.merge(n,l.partials):n,t(e,l)})},"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-pro-badge"]});YUI.add("hermes-template-photo-note-write-mode",function(e,t){var a=e.Template.Handlebars.revive({1:function(e,t,a,n,l){return'<button class="delete-note danger tiny">'+e.escapeExpression((a.intlMessage||t&&t.intlMessage||a.helperMissing).call(null!=t?t:{},{name:"intlMessage",hash:{intlName:"common.DELETE"},data:l}))+"</button>"},compiler:[7,">= 4.0.0"],main:function(e,t,a,n,l){var s,i,o=null!=t?t:{},r=a.helperMissing,c="function",m=e.escapeExpression;return'<div class="note-text adding" data-for-note-yuid="'+m(typeof(i=null!=(i=a.noteYUID||(null!=t?t.noteYUID:t))?i:r)===c?i.call(o,{name:"noteYUID",hash:{},data:l}):i)+'" style="z-index:'+m(typeof(i=null!=(i=a.z||(null!=t?t.z:t))?i:r)===c?i.call(o,{name:"z",hash:{},data:l}):i)+';">\n\t<div class="text-alignment-fix hyphenate" style="left:'+m(typeof(i=null!=(i=a.x||(null!=t?t.x:t))?i:r)===c?i.call(o,{name:"x",hash:{},data:l}):i)+"px;top:"+m(typeof(i=null!=(i=a.y||(null!=t?t.y:t))?i:r)===c?i.call(o,{name:"y",hash:{},data:l}):i)+'px">\n\t\t<textarea class="note-text-textarea unfluid" placeholder="'+m((a.intlMessage||t&&t.intlMessage||r).call(o,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_A_NOTE"},data:l}))+'">'+m(typeof(i=null!=(i=a.text||(null!=t?t.text:t))?i:r)===c?i.call(o,{name:"text",hash:{},data:l}):i)+'</textarea>\n\t\t<div class="note-text-buttons">\n\t\t\t<button class="save-note tiny">'+m((a.intlMessage||t&&t.intlMessage||r).call(o,{name:"intlMessage",hash:{intlName:"common.SAVE"},data:l}))+'</button>\n\t\t\t<button class="cancel-note alt tiny">'+m((a.intlMessage||t&&t.intlMessage||r).call(o,{name:"intlMessage",hash:{intlName:"common.CANCEL"},data:l}))+"</button>"+(null!=(s=a.if.call(o,null!=t?t.canDelete:t,{name:"if",hash:{},fn:e.program(1,l,0),inverse:e.noop,data:l}))?s:"")+"\n\t\t</div>\n\t</div>\n</div>"},useData:!0}),n={};e.Array.each([],function(t){var a=e.Template.get("hermes/"+t);a&&(n[t]=a)}),e.Template.register("hermes/photo-note-write-mode",function(t,l){return l=l||{},l.partials=l.partials?e.merge(n,l.partials):n,a(t,l)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-photo-note-drag-handles",function(a,e){var r=a.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(a,e,r,n,t){return'<span class="note-drag-handle note-drag-handle-tl" data-drag-resize-direction="tl"></span><span class="note-drag-handle note-drag-handle-tr" data-drag-resize-direction="tr"></span><span class="note-drag-handle note-drag-handle-br" data-drag-resize-direction="br"></span><span class="note-drag-handle note-drag-handle-bl" data-drag-resize-direction="bl"></span>'},useData:!0}),n={};a.Array.each([],function(e){var r=a.Template.get("hermes/"+e);r&&(n[e]=r)}),a.Template.register("hermes/photo-note-drag-handles",function(e,t){return t=t||{},t.partials=t.partials?a.merge(n,t.partials):n,r(e,t)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-notes-scrappy-view",function(e,t){function o(t){this.yuid=e.guid(),this.id=t.id,this.photoId=t.photoId,this.x=t.x,this.y=t.y,this.z=0,this.w=t.w,this.h=t.h,this.text=t.text,this.author=t.author,this.authorName=t.authorName,this.authorRealName=t.authorRealName,this.authorIsPro=t.authorIsPro,this.authorProBadge=t.authorProBadge,this.authorIsDeleted=t.authorIsDeleted,this.canEdit=t.canEdit,this.canDelete=t.canDelete,this.isStoredOnServer=t.isStoredOnServer}o.prototype.getScaled=function(e){return{x:this.x*e,y:this.y*e,w:this.w*e,h:this.h*e}};var i=1,n={idle:{begin:"beginIdle",end:"endIdle",events:{mousedown:"handleIdleMouseDown",mouseup:"handleIdleMouseUp",mouseenter:{handler:"handleIdleMouseEnter",delegate:".note"},mouseleave:{handler:"handleIdleMouseLeave",delegate:".note"}}},editing:{begin:"beginEditing",events:{mousedown:"handleEditingMouseDown",mouseup:"handleEditingMouseUp",keydown:"handleEditingKeyDown"}},dragging:{begin:"beginDragging",end:"endDragging",events:{mousemove:"handleDraggingMouseMove",mouseup:"handleDraggingMouseUp"}}};e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this.stateEventHandles=[],this},loadState:function(){var t,o=this;return t={photo:this.appContext.getModel("photo-models",this._params.photoId),photoNotes:this.appContext.getModel("photo-notes-models",this._params.photoId),noteModel:this.appContext.getModelRegistry("note-models")},this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid&&(t.viewer=this.appContext.getModel("person-models",this.appContext.getViewer().nsid)),new e.FlickrPromise(t).then(function(e){o.set("photoModel",e.photo),o.set("photoNotesModel",e.photoNotes),o.set("noteModel",e.noteModel),e.viewer&&o.set("viewer",e.viewer)})},buildContainer:function(){return this},activate:function(){var t,i,n,a,s=this.appContext.flipper.isFlipped("enable-scrappy-notes-deleting"),r=this.appContext.flipper.isFlipped("enable-scrappy-notes-editing"),h=this.get("photoModel"),d=h.getValue("owner").getValue("id"),l=this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid,g=this.get("photoNotesModel").getValue("notes").toJSON();if(h.getValue("isVideo"))return this.deactivate(),this;for(this.box=this.get("container"),this.notes=[],this.canAddNotes=h.getValue("canAddMeta"),this.canAddNotes&&this.box.setStyle("pointerEvents","auto"),this.registerEventHandler(this.box.on("mouseenter",this.revealNotes.bind(this))),this.registerEventHandler(this.box.on("mouseleave",this.hideNotes.bind(this))),this.registerEventHandler(e.on("photo:entering-vr",this.deactivate.bind(this))),i=0;i<g.length;i++)t=g[i],n=r&&(l===d||l===t.author),a=s&&(l===d||l===t.author),this.notes.push(new o({id:t.id,photoId:h.getValue("id"),x:t.left,y:t.top,w:t.width,h:t.height,text:t.text,author:t.author,authorName:t.authorName,authorRealName:t.authorRealName,authorIsPro:t.authorIsPro,authorProBadge:t.authorProBadge,authorIsDeleted:t.authorIsDeleted,canEdit:n,canDelete:a,isStoredOnServer:!0}));return this.restackNotes(),this.syncWithPhoto(),this.renderNotes(),this.revealNotes(),this.pageLoadNotesFlashTimer=setTimeout(this.hideNotes.bind(this),1e3),this.enterState("idle"),this},onParentViewEvent:function(e,t){t&&"photoWellResized"===t[0]&&this.isActivated&&this.box&&(this.syncWithPhoto(),this.renderNotes())},enterState:function(e,t){var o;if(t=t||{},n[e]){for(;this.stateEventHandles.length;)this.stateEventHandles.pop().detach();this.currentState&&n[this.currentState].end&&this[n[this.currentState].end]&&this[n[this.currentState].end].call(this,t);for(var i in n[e].events)"string"==typeof(o=n[e].events[i])?this.stateEventHandles.push(this.box.on(i,this[o].bind(this))):"object"==typeof o&&(o.delegate?this.stateEventHandles.push(this.box.delegate(i,this[o.handler].bind(this),o.delegate)):this.stateEventHandles.push(this.box.on(i,this[o.handler].bind(this))));n[e].begin&&this[n[e].begin]&&this[n[e].begin].call(this,t),this.currentState=e}},revealNotes:function(e){this.box.addClass("box-hovered"),clearTimeout(this.pageLoadNotesFlashTimer)},hideNotes:function(){this.box.removeClass("box-hovered"),this.hideHovered()},beginIdle:function(e){var t=e.element;this.box.removeClass("box-note-clicked"),delete this.draggingMemo,this.box.all(".note-text").remove(!0),t&&t.getDOMNode()&&t.removeClass("note-clicked"),e.rerender&&(this.restackNotes(),this.renderNotes())},endIdle:function(e){this.tempMouseMoveListener&&(this.tempMouseMoveListener.detach(),delete this.tempMouseMoveListener)},handleIdleMouseDown:function(t){var i,n,a,s,r=!1;1!==t.button||t.ctrlKey||t.metaKey||t.target.hasClass("note-text")||(t.target.hasClass("note")&&(i=this.getNoteByID(t.target.getAttribute("data-note-yuid"))),i&&(i.canEdit||i.canDelete)?this.enterState("editing",{note:i,element:t.target}):(a={x:t.clientX,y:t.clientY},s=this.box.getXY(),this.canAddNotes&&(t.preventDefault(),this.tempMouseMoveListener=this.box.on("mousemove",function(t){var i,h,d,l,g;if(i=Math.sqrt(Math.pow(t.clientX-a.x,2)+Math.pow(t.clientY-a.y,2)),h="",!(i<20)){switch(r||(r=!0,this.box.addClass("doing-initial-drag")),h+=a.y-t.clientY>=0?"t":"b",h+=a.x-t.clientX>=0?"l":"r"){case"tl":l=0,g=0;break;case"tr":l=8,g=0;break;case"bl":l=0,g=8;break;case"br":l=8,g=8}d=this.get("viewer"),n=new o({id:e.guid(),photoId:this.get("photoModel").getValue("id"),x:(Math.min(a.x,t.clientX)-s[0]+window.pageXOffset)/this.ratio,y:(Math.min(a.y,t.clientY)-s[1]+window.pageYOffset)/this.ratio,w:Math.abs(a.x-t.clientX)/this.ratio-l,h:Math.abs(a.y-t.clientY)/this.ratio-g,text:"",author:d.getValue("nsid"),authorName:d.getValue("username"),authorRealName:d.getValue("displayname"),authorIsPro:d.getValue("isPro"),authorProBadge:d.getValue("proBadge"),authorIsDeleted:!1,canEdit:!0,canDelete:!0,isStoredOnServer:!1}),this.notes.push(n),this.createNewNote(n),this.storeNoteBackup(n),n.node.append(this.templates("photo-note-drag-handles")()),this.box.addClass("box-note-clicked"),n.node.addClass("note-clicked"),n.node.addClass("note-can-edit"),this.enterState("dragging",{note:n,element:n.node,dragMetadata:{type:"resize",startX:Math.min(a.x,t.clientX)+window.pageXOffset,startY:Math.min(a.y,t.clientY)+window.pageYOffset,dragHandle:n.node.one(".note-drag-handle-"+h),direction:h}})}}.bind(this)))))},handleIdleMouseUp:function(t){this.tempMouseMoveListener&&(this.tempMouseMoveListener.detach(),delete this.tempMouseMoveListener),t.target===this.box&&e.fire("photo:zoom",{x:t.pageX,y:t.pageY})},handleIdleMouseEnter:function(e){var t,o=e.target.ancestor(".note",!0),n=this.getNoteByID(o.getAttribute("data-note-yuid")),a=n.getScaled(this.ratio);this.delayedNoteMouseLeaveHandler&&(this.hideHovered(),clearTimeout(this.delayedNoteMouseLeaveHandler),delete this.delayedNoteMouseLeaveHandler),o.addClass("note-hovered"),o.insert(this.templates("photo-note-read-mode")({x:a.x,y:a.y+a.h+2,z:i,text:n.text.replace(/\n/g,"<br>"),authorName:n.authorRealName||n.authorName,authorURL:"/photos/"+n.author+"/",authorIsPro:n.authorIsPro,authorProBadge:n.authorProBadge,authorIsDeleted:n.authorIsDeleted}),"after"),(t=this.box.one(".note-text")).get("region").width+a.x>window.innerWidth&&t.one(".text-alignment-fix").setStyle("left",a.x-t.get("region").width+a.w+"px"),t.on("mouseenter",function(e){this.delayedNoteMouseLeaveHandler&&(clearTimeout(this.delayedNoteMouseLeaveHandler),delete this.delayedNoteMouseLeaveHandler)}.bind(this)),t.on("mouseleave",this.handleIdleMouseLeave.bind(this))},handleIdleMouseLeave:function(e){this.delayedNoteMouseLeaveHandler=setTimeout(this.hideHovered.bind(this),100)},beginEditing:function(e){var t,o=e.note,n=e.element,a=o.getScaled(this.ratio);this.storeNoteBackup(o),this.hideHovered(),this.box.hasClass("box-note-clicked")||this.box.addClass("box-note-clicked"),n.hasClass("note-clicked")||n.addClass("note-clicked"),0===n.siblings(".note-text.adding").size()&&n.insert(this.templates("photo-note-write-mode")({noteYUID:o.yuid,x:a.x,y:a.y+a.h+2,z:i,text:o.text.replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),canDelete:o.isStoredOnServer}),"after"),(t=this.box.one(".note-text")).get("region").width+a.x>window.innerWidth&&t.one(".text-alignment-fix").setStyle("left",a.x-t.get("region").width+a.w+"px"),n.one(".note-drag-handle")||n.append(this.templates("photo-note-drag-handles")()),setTimeout(function(){this.box.one(".note-text[data-for-note-yuid="+o.yuid+"] textarea").focus()}.bind(this),10)},handleEditingMouseDown:function(e){var t,o,i;1!==e.button||e.ctrlKey||e.metaKey||(o=e.target.ancestor(".note",!0))&&(t=this.getNoteByID(o.getAttribute("data-note-yuid")))&&t.canEdit&&(e.target.hasClass("note-drag-handle")?i={type:"resize",startX:e.clientX+window.pageXOffset,startY:e.clientY+window.pageYOffset,dragHandle:e.target,direction:e.target.getAttribute("data-drag-resize-direction")}:e.target.hasClass("note-clicked")&&(i={type:"move",startX:e.clientX+window.pageXOffset,startY:e.clientY+window.pageYOffset,dragHandle:e.target}),i&&this.enterState("dragging",{note:t,element:o,dragMetadata:i}))},handleEditingMouseUp:function(e){e.target.test("button")&&this.performButtonAction(e)},handleEditingKeyDown:function(e){var t=this.box.one(".note-clicked"),o=this.getNoteByID(t.getAttribute("data-note-yuid"));switch(e.keyCode){case 8:(e.ctrlKey||e.metaKey)&&window.confirm(this.intlMessage({intlName:"photo-page-scrappy.CONFIRM_NOTE_DELETION"}))&&(this.deleteNote(o,t),e.preventDefault());break;case 13:(e.ctrlKey||e.metaKey)&&(this.saveNoteEdits(o,t),e.preventDefault()),e.target.test("button")&&this.performButtonAction(e);break;case 27:this.cancelNoteEdits(o,t);break;case 32:e.target.test("button")&&this.performButtonAction(e)}},performButtonAction:function(e){var t=this.box.one(".note-clicked"),o=this.getNoteByID(t.getAttribute("data-note-yuid"));e.target.hasClass("save-note")?this.saveNoteEdits(o,t):e.target.hasClass("cancel-note")?this.cancelNoteEdits(o,t):e.target.hasClass("delete-note")&&window.confirm(this.intlMessage({intlName:"photo-page-scrappy.CONFIRM_NOTE_DELETION"}))&&this.deleteNote(o,t)},saveNoteEdits:function(e,t){var o=this.get("noteModel"),i=this;e.text=i.box.one(".note-text[data-for-note-yuid="+e.yuid+"] textarea").get("value").trim(),e.text&&(e.isStoredOnServer?(o.setValues(e.id,{left:e.x,top:e.y,width:e.w,height:e.h,text:e.text}),o.remoteUpdate(e.id).then(function(o){o&&(e.text=o.getValue("text")),i.deleteNoteBackup(),i.enterState("idle",{note:e,element:t,rerender:!0})},function(e){})):o.remoteCreate({photoId:e.photoId,left:e.x,top:e.y,width:e.w,height:e.h,text:e.text,author:e.author,authorName:e.authorName,authorRealName:e.authorRealName,authorIsPro:e.authorIsPro,authorProBadge:e.authorProBadge,authorIsDeleted:!1}).then(function(o){e.id=o.getValue("id"),e.text=o.getValue("text"),e.isStoredOnServer=!0,i.deleteNoteBackup(),i.enterState("idle",{note:e,element:t,rerender:!0})},function(e){}))},cancelNoteEdits:function(e,t){var o;e.isStoredOnServer?(o=this.getNoteBackup(),e.w=o.w,e.h=o.h,e.x=o.x,e.y=o.y,this.positionNote(e)):(this.notes.pop(),this.box.one("[data-note-yuid="+e.yuid+"]").remove(!0),e=null,t=null),this.deleteNoteBackup(),this.enterState("idle",{note:e,element:t})},deleteNote:function(e,t){var o,i=this,n=!1;this.get("noteModel").remoteDelete(e.id).then(function(a){for(t.remove(!0),o=i.notes.length-1;o>=0;o--)if(i.notes[o].id===e.id){n=!0;break}n&&i.notes.splice(o,1),i.deleteNoteBackup(),i.enterState("idle",{note:e,element:t})},function(e){})},beginDragging:function(t){this.draggingMemo=e.merge(t.dragMetadata,{note:t.note,noteAtStart:e.clone(t.note),element:t.element})},endDragging:function(e){this.box.removeClass("doing-initial-drag")},handleDraggingMouseMove:function(e){var t,o,i,n,a,s,r,h,d,l,g,u,c,p=19/this.ratio;if(t=this.draggingMemo.note,o=this.draggingMemo.startX-e.clientX-window.pageXOffset,i=this.draggingMemo.startY-e.clientY-window.pageYOffset,this.boxWidth>this.boxHeight?(u=500,c=500/(this.boxWidth/this.boxHeight)):(c=500,u=500/(this.boxHeight/this.boxWidth)),"resize"===this.draggingMemo.type){switch(this.draggingMemo.direction){case"tl":n=o/this.ratio*-1,s=o/this.ratio,a=i/this.ratio*-1,r=i/this.ratio;break;case"tr":n=0,s=o/this.ratio*-1,a=i/this.ratio*-1,r=i/this.ratio;break;case"br":n=0,s=o/this.ratio*-1,a=0,r=i/this.ratio*-1;break;case"bl":n=o/this.ratio*-1,s=o/this.ratio,a=0,r=i/this.ratio*-1}h=this.draggingMemo.noteAtStart.x+n,l=this.draggingMemo.noteAtStart.w+s,d=this.draggingMemo.noteAtStart.y+a,g=this.draggingMemo.noteAtStart.h+r,l<p&&(n&&(h=this.draggingMemo.noteAtStart.w+this.draggingMemo.noteAtStart.x-p),l=p),l+h>u&&(l=u-h),h<0&&(h=0,l=this.draggingMemo.noteAtStart.w+this.draggingMemo.noteAtStart.x),t.x=h,t.w=l,g<p&&(a&&(d=this.draggingMemo.noteAtStart.h+this.draggingMemo.noteAtStart.y-p),g=p),g+d>c&&(g=c-d),d<0&&(d=0,g=this.draggingMemo.noteAtStart.h+this.draggingMemo.noteAtStart.y),t.y=d,t.h=g}else"move"===this.draggingMemo.type&&(h=this.draggingMemo.noteAtStart.x-o/this.ratio,d=this.draggingMemo.noteAtStart.y-i/this.ratio,h<0&&(h=0),h+this.draggingMemo.noteAtStart.w>u&&(h=u-this.draggingMemo.noteAtStart.w),d<0&&(d=0),d+this.draggingMemo.noteAtStart.h>c&&(d=c-this.draggingMemo.noteAtStart.h),t.x=h,t.y=d);this.positionNote(t)},handleDraggingMouseUp:function(e){this.enterState("editing",{note:this.draggingMemo.note,element:this.draggingMemo.element})},storeNoteBackup:function(t){this.noteBeforeEdits||(this.noteBeforeEdits=e.clone(t))},getNoteBackup:function(){return this.noteBeforeEdits},deleteNoteBackup:function(){delete this.noteBeforeEdits},getNoteByID:function(e){return this.notes.find?this.notes.find(function(t){return t.yuid===e}):this.notes.filter(function(t){return t.yuid===e})[0]},renderNotes:function(){var t,o,i=this.getNoteBackup();i&&(t=e.clone(i.node.getDOMNode())),this.box.all(".note").remove(!0),this.notes.forEach(this.createNewNote.bind(this)),i&&((o=this.box.one("[data-note-yuid="+i.yuid+"]")).set("className",t.className),i.node=o)},createNewNote:function(t){t.node=e.Node.create('<span class="note" data-note-yuid="'+t.yuid+'"></span>'),t.canEdit&&t.node.addClass("note-can-edit"),this.box.append(t.node),this.positionNote(t)},positionNote:function(e){var t,o=e.getScaled(this.ratio);e.node.setStyles({left:o.x+"px",top:o.y+"px",width:o.w+"px",height:o.h+"px",zIndex:e.z}),(t=this.box.one(".note-text[data-for-note-yuid="+e.yuid+"]"))&&(t.setStyle("z-index",i),t.one(".text-alignment-fix").setStyles({left:o.x+"px",top:o.y+o.h+2+"px"}))},restackNotes:function(){this.notes.sort(function(e,t){return t.w*t.h-e.w*e.h}).forEach(function(e){e.z=i++})},syncWithPhoto:function(){var t=e.one(".photo-well-media-scrappy-view").getDOMNode(),o=parseInt(getComputedStyle(t).paddingTop,10),i=parseInt(getComputedStyle(t).paddingBottom,10),n=t.offsetWidth,a=t.offsetHeight-o-i,s=t.offsetLeft,r=t.offsetTop+o;this.box.setStyles({width:n+"px",height:a+"px",left:s+"px",top:r+"px"}),this.ratio=Math.max(n,a)/500,this.boxWidth=n,this.boxHeight=a,this.boxLeft=s,this.boxTop=r},hideHovered:function(){this.box.all(".note-hovered").removeClass("note-hovered"),this.box.all(".note-text:not(.adding)").remove(!0)},deactivate:function(){this.get("container").setStyle("display","none").remove()}})},"@VERSION@",{requires:["hermes-template-photo-note-read-mode","hermes-template-photo-note-write-mode","hermes-template-photo-note-drag-handles","flickr-view"],optional:["photo-notes-models","photo-models"],langBundles:["common","photo-page-scrappy"]});YUI.add("hermes-template-photo-sidebar-toggle",function(e,a){var n=e.Template.Handlebars.revive({1:function(e,a,n,l,r){return"Close"},3:function(e,a,n,l,r){return"Open"},5:function(e,a,n,l,r){return"fullscreen"},7:function(e,a,n,l,r){return"&#10529;"},9:function(e,a,n,l,r){return"&#10530;"},compiler:[7,">= 4.0.0"],main:function(e,a,n,l,r){var t,s,i=null!=a?a:{};return'<a href="'+e.escapeExpression("function"==typeof(s=null!=(s=n.url||(null!=a?a.url:a))?s:n.helperMissing)?s.call(i,{name:"url",hash:{},data:r}):s)+'" class="toggle" data-track="lightbox'+(null!=(t=n.if.call(i,null!=a?a.isRealFullscreen:a,{name:"if",hash:{},fn:e.program(1,r,0),inverse:e.program(3,r,0),data:r}))?t:"")+'Click">\n\t<span class="toggle-icon hide-text '+(null!=(t=n.if.call(i,null!=a?a.isRealFullscreen:a,{name:"if",hash:{},fn:e.program(5,r,0),inverse:e.noop,data:r}))?t:"")+'">'+(null!=(t=n.if.call(i,null!=a?a.isRealFullscreen:a,{name:"if",hash:{},fn:e.program(7,r,0),inverse:e.program(9,r,0),data:r}))?t:"")+"</span>\n</a>"},useData:!0}),l={};e.Array.each([],function(a){var n=e.Template.get("hermes/"+a);n&&(l[a]=n)}),e.Template.register("hermes/photo-sidebar-toggle",function(a,r){return r=r||{},r.partials=r.partials?e.merge(l,r.partials):l,n(a,r)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-sidebar-toggle-view",function(t){t.FlickrView.create(this.name,t.FlickrView,[],{initializer:function(e){return this.photoId=e.photoId,this.realFullscreen=!!e.realFullscreen,this.contextData=t.clone(e.context,!0),this.inlineStyling=e.inlineStyling,this},loadState:function(){var e=this,i=[];return i.push(this.appContext.getModel("photo-models",this.photoId).then(function(t){t&&e.set("photo",t)})),this.contextData&&this.contextData.modelName&&this.contextData.params&&i.push(this.appContext.getModel(this.contextData.modelName,this.contextData.params).then(function(t){t&&e.set("contextModel",t)}).then(null,function(){return"whatever"})),t.Promise.all(i)},buildContainer:function(){var t=this.appContext.experiments.fullscreen.getMode(),e=this.get("container");return this.inlineStyling&&e.addClass("inline"),this.setContainerWithTemplate("photo-sidebar-toggle",{isRealFullscreen:t,url:this.getLightboxURL()}),e.addClass("show"),this},activate:function(){var e=this;return this.attachKeyEvent("down:76",function(i){i.preventDefault(),t.rapidTracker.beacon(e.name,"lightbox"+(e.appContext.experiments.fullscreen.getMode()?"Close":"Open")+"KeyPress"),e.appContext.flapp.navigate(e.getLightboxURL())}),this.appContext.flipper.isFlipped("enable-scrappy-photo-page")&&this.attachKeyEvent("up:27",function(i){e.appContext.experiments.fullscreen.getMode()&&(i.preventDefault(),t.rapidTracker.beacon(e.name,"lightboxCloseEscKeyPress"),e.appContext.flapp.navigate(e.getLightboxURL()))}),this},getLightboxURL:function(){var e=this.get("photo"),i="";return this.get("contextModel")&&(i=this.get("contextModel").getValue("urlSuffix")),e?t.URLHelper.getPhotoPage({photoId:e.getValue("id"),pathAlias:e.getValue("owner").getValue("pathAlias"),contextSuffix:i,lightbox:!this.appContext.experiments.fullscreen.getMode()}):"#"}})},"@VERSION@",{requires:["flickr-view","hermes-template-photo-sidebar-toggle","promise"]});