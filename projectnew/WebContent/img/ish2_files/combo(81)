YUI.add("photo-group-invitations-models",function(t){function e(t){e.superclass.constructor.call(this,t)}t.Models[this.name]=e,t.extend(e,t.FlickrModelRegistry,{name:this.name,remote:{read:function(e){return t.ListFetchers["flickr-photos-getGroupInvitations"].run(e,this.appContext)},acceptInvitation:function(e,i){return t.ModelUpdaters["flickr-groups-invite-photo-accept"].run(e,i)},declineInvitation:function(e,i){return t.ModelUpdaters["flickr-groups-invite-photo-decline"].run(e,i)}},attributes:{id:{},groups:{isListProxy:!0},invitations:{isListProxy:!0},total:{validator:function(e){return t.AttributeHelpers.validateInteger(e)},setter:function(e){return t.AttributeHelpers.coerceInteger(e)},defaultValue:0}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-promise","flickr-photos-getGroupInvitations-fetcher","flickr-groups-invite-photo-accept-updater","flickr-groups-invite-photo-decline-updater"]});YUI.add("sub-photo-groups-view",function(t){t.FlickrView.create(this.name,t.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){this.photoId=t.photoId,this.list=[],this.loading=!1,this.removing={},this.accepting={},this.startAmount=6,this.perPage=50,this.displayAmount=this.startAmount,this.addKeyShortcut="down:71",this.wasInvitation=[],void 0!==this.getViewDataFromHistory("displayAmount")&&(this.startAmount=this.getViewDataFromHistory("displayAmount"),this.displayAmount=this.getViewDataFromHistory("displayAmount")),""===this.get("container").get("innerHTML")&&this.setContainerHTML("")},loadState:function(){var e,o=this;return e={photoGroupsModel:this.appContext.getModel("photo-groups-models",this.photoId),photoModel:this.appContext.getModel("photo-models",this.photoId),photoPrivacyModel:this.appContext.getModel("photo-privacy-models",this.photoId)},this.appContext.getViewer().signedIn&&(e.photoGroupInvitationsModel=this.appContext.getModel("photo-group-invitations-models",this.photoId),e.personGroupsModel=this.appContext.getModel("person-groups-models",this.appContext.getViewer().nsid)),new t.FlickrPromise(e).then(function(e){return t.Object.each(e,function(t,e){o.set(e,t)}),o.loadListData()})},loadListData:function(){var e=this;return this.loading=!0,new t.FlickrPromise({invitations:this.getInvitations(this.displayAmount),groups:this.getGroups(this.displayAmount)}).then(function(o){var i,n,s=e.list,a=[];return e.loading=!1,a=[],o.invitations.length&&(a=a.concat(o.invitations)),a.length<e.displayAmount&&o.groups.length&&(n=function(t,o){var i=t.getValue("group").getValue("isAdmin"),n=o.getValue("group").getValue("isAdmin"),s=e.wasInvitation.indexOf(t.id),a=e.wasInvitation.indexOf(o.id);return s>-1&&a>-1?s>a?-1:1:s>-1?-1:a>-1?1:i>n?-1:n>i?1:0},a=o.invitations.concat(o.groups.sort(n))),a.length>e.displayAmount&&(a=a.slice(0,e.displayAmount)),!(function(e,o){var i;return e===o||e.length===o.length&&(i=!0,t.Array.some(e,function(t,e){if(t!==o[e])return i=!1,!0}),i)})(s,a)?(e.list=a,i=!0):i=!1,{listChanged:i}})},getInvitations:function(e){var o=this.get("photoGroupInvitationsModel"),i=o&&o.getValue("groups"),n=i&&i.getList();return n?t.Promise.resolve(n.slice(0,e)):t.Promise.resolve([])},getGroups:function(e){var o=this.get("photoGroupsModel"),i=o.getValue("groups").getList(),n=o.getValue("total");return e>n&&(e=n),i.length<e?o.getListPageByContinuation(e-i.length).then(function(){return o.getValue("groups").getList().slice(0,e)}):t.Promise.resolve(i.slice(0,e))},getInvitationModelForGroup:function(e){var o,i=this.get("photoGroupInvitationsModel"),n=i&&i.getValue("invitations").getList();return n&&t.Array.some(n,function(t){if(t.getValue("groupId")===e)return o=t,!0}),o},canViewerRemove:function(t){var e=this.appContext.getViewer().nsid,o=this.get("photoModel").getValue("owner").getValue("id"),i=this.getInvitationModelForGroup(t.getValue("id")),n=t.getValue("group").getValue("isAdmin"),s=t.getValue("group").getValue("isModerator");return!!i?o===e||(!(!i||i.getValue("invitedBy")!==e)||!(!n&&!s)):o===e||!(!n&&!s)},canViewerAdd:function(){var t=this.appContext.getViewer().nsid,e=this.get("photoModel").getValue("owner").getValue("id"),o=this.get("personGroupsModel");return e===t&&o&&(this.get("personGroupsModel").getValue("memberCount")>0||this.get("personGroupsModel").getValue("adminCount")>0||this.get("personGroupsModel").getValue("moderatorCount")>0)},canViewerInvite:function(){var t=this.appContext.getViewer().nsid,e=this.get("photoModel").getValue("owner").getValue("id"),o=this.get("personGroupsModel");return e!==t&&o&&o.getValue("adminCount")>0},listToJSON:function(){var t=this;return this.list.map(function(e){var o=e.toJSON(),i=t.getInvitationModelForGroup(e.getValue("id"));return o.isGroup=!0,o.canRemove=t.canViewerRemove(e),i?(o.isInvitation=!0,o.invitedBy=i.getValue("invitedBy"),o.invitedByViewer=i.getValue("invitedBy")===t.appContext.getViewer().nsid,o.invitedByViewer||(o.truncateTitle=!0)):(o.isInvitation=!1,o.url=o.group.url),o})},buildContainer:function(){var e=this.get("photoGroupInvitationsModel")?this.get("photoGroupInvitationsModel").getValue("total"):0,o=this.get("photoGroupsModel").getValue("total"),i=e+o>this.displayAmount,n=this.canViewerAdd(),s=this.canViewerInvite(),a=this.appContext.getViewer().nsid,r=this.get("photoModel").getValue("owner").getValue("id")===a;this.setContainerWithTemplate("sub-photo-contexts-groups",{empty:0===this.list.length,canAdd:n,canInvite:s,canAddOrInvite:n||s,contexts:this.listToJSON(),showMore:i,totalGroups:o,totalInvitations:e,totalInvitationsFriendly:t.Number.format(e,{thousandsSeparator:","}),viewerIsOwner:r})},activate:function(){var t=this,e=this.get("container");return(this.canViewerAdd()||this.canViewerInvite())&&(this.get("photoGroupInvitationsModel")&&this.registerEventHandler(this.get("photoGroupInvitationsModel").on("valuesChanged",this.handleListChanges.bind(this))),this.get("photoGroupsModel")&&this.registerEventHandler(this.get("photoGroupsModel").on("valuesChanged",this.handleListChanges.bind(this))),this.attachKeyEvent(this.addKeyShortcut,function(e){e.preventDefault(),t.showAddDialog()})),this.registerEventHandler(e.on("click",this.handleContainerClick.bind(this))),this},handleListChanges:function(t){this.loading||this.reload()},handleContainerClick:function(t){var e;t.target.ancestor(".remove",!0)||t.target.ancestor(".cancel-invite",!0)?(t.preventDefault(),e=t.target.ancestor("li"),this.removeFromContext(e.getAttribute("data-context-id"),e)):t.target.ancestor(".accept-invite",!0)?(t.preventDefault(),e=t.target.ancestor("li"),this.acceptInvitation(e.getAttribute("data-context-id"),e)):t.target.ancestor(".add-to",!0)?(t.preventDefault(),this.showAddDialog()):t.target.ancestor(".view-all-contexts-of-type a",!0)&&(t.preventDefault(),this.showMore())},showMore:function(){this.displayAmount===this.startAmount&&this.startAmount<this.perPage?this.displayAmount=this.perPage:this.displayAmount+=this.perPage,this.setViewDataOnHistory("displayAmount",this.displayAmount),this.reload()},reload:function(){var t=this;this.loadListData().then(function(e){e.listChanged&&t.buildContainer()})},removeFromContext:function(t,e){var o,i,n=this,s=!!this.getInvitationModelForGroup(t),a=this.appContext.getViewer().nsid,r=this.get("photoModel").getValue("owner").getValue("id"),l={photoID:this.photoId,groupID:t};this.removing[t]||(this.removing[t]=!0,e.setStyle("opacity","0"),s?(r===a?(o="photo-group-invitations-models",i="declineInvitation",l.userID=r):(o="group-pool-models",i="cancelPhotoInvitation"),this.get("photoGroupInvitationsModel")):(o="group-pool-models",i="removePhoto",this.get("photoGroupsModel")),this.appContext.getModelRegistry(o).then(function(o){o.remote[i](l,n.appContext).then(function(e){delete n.removing[t],n.reload()},function(o){throw delete n.removing[t],e.setStyle("opacity","1"),o}).then(null,function(t){throw n.onError({message:n.intlMessage({intlName:"photo-page-scrappy.ERROR_REMOVING_FROM_GROUP"}),err:t}),t})}))},acceptInvitation:function(t,e){var o=this,i={userID:this.appContext.getViewer().nsid,photoID:this.photoId,groupID:t};this.accepting[t]||(this.accepting[t]=!0,this.appContext.getModelRegistry("photo-group-invitations-models").then(function(e){return e.remote.acceptInvitation(i,o.appContext).then(function(){delete o.accepting[t],o.wasInvitation.push(t),o.reload()},function(e){throw delete o.accepting[t],e}).then(null,function(t){throw o.onError({message:o.intlMessage({intlName:"photo-page-scrappy.ERROR_ACCEPTING_INVITATION"}),err:t}),t})}))},showAddDialog:function(){this.appContext.flipper.isFlipped("enable-megadroparound")?this.showAddToStuff():this.showGroupDialog()},showGroupDialog:function(){function e(){n=r?h.intlMessage({intlName:"more-menu-view.NO_GROUPS"}):h.intlMessage({intlName:"more-menu-view.NO_GROUPS_ADMIN"}),(o=new t.Views["group-selection-dialog-view"]({type:"group",titleSelect:l,loadingText:h.intlMessage({intlName:"more-menu-view.LOADING_GROUPS"}),noneText:n,placeholderSearch:h.intlMessage({intlName:"photo-page-scrappy.SEARCH_GROUPS"}),buttonTextComplete:"",canCreateNew:!1,photoID:h.photoId,viewerIsOwner:r,appContext:h.appContext})).on("subviewViewEvent",function(t){t&&t.details&&2===t.details.length&&h.fire("subviewViewEvent",t.details[0],t.details[1])}),(s=new t.Views.FluidModal({appContext:h.appContext,title:l,subview:o,actionButtonLabel:h.intlMessage({intlName:"common.DONE"}),classList:"fluid-album-modal scrappy-dialog",showCancelButton:!1,showActionButton:!1,dismissOnOverlayClick:!0,hideModalOverlay:!0,showFooter:!1,width:748,height:514})).on("activated",function(){o.get("container").one(".album-selection-done").on("click",function(){s.close()})}),s.show(),s.unfreeze()}var o,i,n,s,a=this.appContext.getViewer().nsid,r=this.get("photoModel").getValue("owner").getValue("id")===a,l=r?this.intlMessage({intlName:"more-menu-view.ADD_PHOTO_TO_GROUP"}):this.intlMessage({intlName:"more-menu-view.INVITE_PHOTO_TO_GROUP"}),h=this;this.get("photoPrivacyModel").getValue("isPublic")||localStorage.getItem("dontShowPrivatePhotoGroupsWarningAgain")&&null!==localStorage.getItem("dontShowPrivatePhotoGroupsWarningAgain")||!r?e():h.fire("subviewViewEvent","getDialogOffset",function(o){(i=t.Views.dialog.getNewInstance("dialog-alert",{content:"<p>"+h.intlMessage({intlName:"more-menu-view.GROUP_PRIVACY_WARNING"})+'</p><p><input type="checkbox" id="dont-show-again" /> <label for="dont-show-again">'+h.intlMessage({intlName:"more-menu-view.DONT_SHOW_ME_AGAIN"})+"</label></p>",attrs:{title:h.intlMessage({intlName:"common.WARNING"}),level:"ui-icon-modal-warning",confirmLabel:h.intlMessage({intlName:"common.OK"})},parent:h,offsetLeft:o,dialogClass:"scrappy-dialog"})).show(),i.on("hide",function(t){i.get("container").one("input").get("checked")&&localStorage.setItem("dontShowPrivatePhotoGroupsWarningAgain",!0),e()})}),t.rapidTracker.beacon(this.name,"addToGroupClick")},showAddToStuff:function(){var e=this.get("photoModel").getValue("isOwner");new t.CurationHelper(this.appContext,{view:this}).showAddToCuration({photoId:this.get("photoModel").getValue("id"),showAlbums:e,showGalleries:!e,initialTab:"group",useViewportType:!1,containerType:"modal"})},onError:function(e){var o=this;this.fire("subviewViewEvent","getDialogOffset",function(i){t.Views.dialog.getNewInstance("dialog-alert",{content:e.message,attrs:{title:o.intlMessage({intlName:"common.ERROR"}),level:"warning",confirmLabel:o.intlMessage({intlName:"common.OK"})},parent:o,offsetLeft:i,dialogClass:"scrappy-dialog"}).show()})}})},"@VERSION@",{requires:["array-extras","flickr-view","fluid-modal-view","flickr-promise","hermes-template-sub-photo-contexts-item","hermes-template-sub-photo-contexts-title-groups","hermes-template-sub-photo-contexts-groups","url-helper","dialog","group-selection-dialog-view","add-to-stuff-view","curation-helper"],optional:["photo-group-invitations-models","photo-groups-models","photo-models","person-groups-models","group-pool-models"],langBundles:["more-menu-view","photo-page-scrappy","common"]});YUI.add("hermes-template-sub-photo-contexts-title-albums",function(e,a){var n=e.Template.Handlebars.revive({1:function(e,a,n,t,l){return"\t\t"+e.escapeExpression((n.intlMessage||a&&a.intlMessage||n.helperMissing).call(null!=a?a:{},{name:"intlMessage",hash:{intlName:"photo-page-scrappy.PHOTO_IN_ONE_ALBUM"},data:l}))+"\n"},3:function(e,a,n,t,l){return"\t\t"+e.escapeExpression((n.intlMessage||a&&a.intlMessage||n.helperMissing).call(null!=a?a:{},{name:"intlMessage",hash:{count:null!=a?a.totalFriendly:a,intlName:"photo-page-scrappy.PHOTO_IN_N_ALBUMS"},data:l}))+"\n"},compiler:[7,">= 4.0.0"],main:function(e,a,n,t,l){var s,i=null!=a?a:{},r=n.helperMissing;return'<h5 class="total" tabindex="0">\n'+(null!=(s=(n.ifCond||a&&a.ifCond||r).call(i,null!=a?a.total:a,"===",1,{name:"ifCond",hash:{},fn:e.program(1,l,0),inverse:e.noop,data:l}))?s:"")+(null!=(s=(n.ifCond||a&&a.ifCond||r).call(i,null!=a?a.total:a,">",1,{name:"ifCond",hash:{},fn:e.program(3,l,0),inverse:e.noop,data:l}))?s:"")+"</h5>\n"},useData:!0}),t={};e.Array.each([],function(a){var n=e.Template.get("hermes/"+a);n&&(t[a]=n)}),e.Template.register("hermes/sub-photo-contexts-title-albums",function(a,l){return l=l||{},l.partials=l.partials?e.merge(t,l.partials):t,n(a,l)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-sub-photo-contexts-albums",function(t,e){var a=t.Template.Handlebars.revive({1:function(t,e,a,n,s){var l;return null!=(l=a.if.call(null!=e?e:{},null!=e?e.canAdd:e,{name:"if",hash:{},fn:t.program(2,s,0),inverse:t.noop,data:s}))?l:""},2:function(t,e,a,n,s){var l=null!=e?e:{},o=a.helperMissing,r=t.escapeExpression;return'\t\t<div class="sub-photo-context sub-photo-context-albums empty">\n\t\t\t<p tabindex="0">'+r((a.intlMessage||e&&e.intlMessage||o).call(l,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.PHOTO_NOT_IN_ALBUMS"},data:s}))+"</p>\n\t\t\t<p><a href='#' class='add-to'>"+r((a.intlMessage||e&&e.intlMessage||o).call(l,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_TO_ALBUM"},data:s}))+"</a></p>\n\t\t</div>\n"},4:function(t,e,a,n,s){var l,o=null!=e?e:{};return'\t<div class="sub-photo-context sub-photo-context-albums">\n'+(null!=(l=t.invokePartial(n["sub-photo-contexts-title-albums"],e,{name:"sub-photo-contexts-title-albums",data:s,indent:"\t\t",helpers:a,partials:n,decorators:t.decorators}))?l:"")+(null!=(l=a.if.call(o,null!=e?e.canAdd:e,{name:"if",hash:{},fn:t.program(5,s,0),inverse:t.noop,data:s}))?l:"")+'\t\t<ul class="context-list">\n'+(null!=(l=a.each.call(o,null!=e?e.contexts:e,{name:"each",hash:{},fn:t.program(7,s,0),inverse:t.noop,data:s}))?l:"")+"\t\t</ul>\n"+(null!=(l=a.if.call(o,null!=e?e.showMore:e,{name:"if",hash:{},fn:t.program(9,s,0),inverse:t.noop,data:s}))?l:"")+"\t</div>\n"},5:function(t,e,a,n,s){return"\t\t\t<a href='#' class='add-to'>"+t.escapeExpression((a.intlMessage||e&&e.intlMessage||a.helperMissing).call(null!=e?e:{},{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_TO_ALBUM"},data:s}))+"</a>\n"},7:function(t,e,a,n,s){var l;return null!=(l=t.invokePartial(n["sub-photo-contexts-item"],e,{name:"sub-photo-contexts-item",data:s,indent:"\t\t\t\t",helpers:a,partials:n,decorators:t.decorators}))?l:""},9:function(t,e,a,n,s){return'\t\t\t<div class="view-all-contexts-of-type"><a href="#">'+t.escapeExpression((a.intlMessage||e&&e.intlMessage||a.helperMissing).call(null!=e?e:{},{name:"intlMessage",hash:{intlName:"photo-page-scrappy.VIEW_MORE_ALBUMS"},data:s}))+"</a></div>\n"},compiler:[7,">= 4.0.0"],main:function(t,e,a,n,s){var l;return null!=(l=a.if.call(null!=e?e:{},null!=e?e.empty:e,{name:"if",hash:{},fn:t.program(1,s,0),inverse:t.program(4,s,0),data:s}))?l:""},usePartial:!0,useData:!0}),n={};t.Array.each(["sub-photo-contexts-title-albums","sub-photo-contexts-item"],function(e){var a=t.Template.get("hermes/"+e);a&&(n[e]=a)}),t.Template.register("hermes/sub-photo-contexts-albums",function(e,s){return s=s||{},s.partials=s.partials?t.merge(n,s.partials):n,a(e,s)})},"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-sub-photo-contexts-title-albums","hermes-template-sub-photo-contexts-item"]});YUI.add("set-selection-dialog-view",function(e,t){var o=require("hermes-core/flog")(t);e.namespace("Views")[this.name]=e.Base.create("set-selection-dialog-view",e.Views["album-selection-dialog-view"],[],{langBundles:this.details.langBundles,initialLoad:function(){var t=this;return this.set("scrappy",this.appContext.flipper.isFlipped("enable-scrappy-photo-page")),this.appContext.flipper.isFlipped("rename-set-to-album")?(this.setLabel=this.intlMessage({intlName:"photo-page-scrappy.ALBUM"}),this.setsLabel=this.intlMessage({intlName:"photo-page-scrappy.ALBUMS"})):(this.setLabel="set",this.setsLabel="sets"),this.set("page",1),this.set("perPage",this.appContext.flipper.isFlipped("enable-sets-list-loading-fix")?50:500),this.appContext.getModel("sets-models",{id:t.appContext.auth.user.nsid,page:t.get("page"),perPage:t.get("perPage")}).then(function(e){t.set("setsModel",e)}).then(function(){var s={setsList:t.get("setsModel").getValue("albumsList").getPage({page:t.get("page"),perPage:t.get("perPage")})};return t.get("isMultiplePhotos")?s.albumsSharedBetweenPhotos=t.appContext.callAPI("flickr.cameraroll.getPhotosMeta",{photo_ids:t.get("photoID"),properties:"albums"},!0):s.setsThePhotoIsIn=t.appContext.getModel("photo-sets-models",t.get("photoID")).then(function(e){return e.getListPageByContinuation(t.get("perPage")).then(function(){return e.getValue("sets").getList()})}),new e.FlickrPromise(s).then(function(e){var o,s=e.setsList,r=e.setsThePhotoIsIn?e.setsThePhotoIsIn:[],n=[],i=[];for(t.get("isMultiplePhotos")&&e.albumsSharedBetweenPhotos.albums&&e.albumsSharedBetweenPhotos.albums.forEach(function(e){i.push({getValue:function(t){return e[t]}})}),o=0;o<s.length;o++)s[o].getValue("isAutoUploadSet")||n.push(s[o].toJSON());t.set("albumList",n),t.set("albumListForPhoto",t.get("isMultiplePhotos")?i:r),t.set("setsShowingCount",t.get("perPage")),t.recursivelyLoadMore()}).then(null,function(e){throw o.error({err:e}),t.onError({message:t.intlMessage({intlName:"photo-page-scrappy.ERROR_LOADING_ALBUMS"}),err:e}),e})})},recursivelyLoadMore:function(){var e,t=this,o=this.get("setsShowingCount"),s=t.get("setsModel").getValue("totalItems");o<s&&s>0&&(t.appendLoader(),t.set("page",t.get("page")+1),this.get("setsModel").getValue("albumsList").getPage({page:t.get("page"),perPage:t.get("perPage")}).then(function(o){for(t.removeLoader(),e=0;e<o.length;e++)o[e]=o[e].toJSON();t.appendAlbums(o),t.set("setsShowingCount",t.get("setsShowingCount")+t.get("perPage")),t.recursivelyLoadMore()}).then(null,function(e){throw t.removeLoader(),t.onError({message:t.intlMessage({intlName:"photo-page-scrappy.ERROR_LOADING_ALBUMS"}),err:e}),e}))},addPhoto:function(t){var o=this,s=this.get("multiplePhotosBatchSize"),r=[],n=0,i=[],a=[];if(this.get("isMultiplePhotos"))for(r=this.get("photoID").split(","),n=r.length;r.length>0;)i.push(r.splice(0,s));return this.appContext.getModelRegistry("set-models").then(function(s){return o.get("isMultiplePhotos")?(i.forEach(function(e,r){a.push(function(){return s.remote.addPhoto({photoID:e.join(","),isMultiplePhotos:!0,numberOfPhotosSelected:o._params.numberOfPhotosSelected,numberOfVideosSelected:o._params.numberOfVideosSelected,photosSelectedIds:o._params.photosSelectedIds,videosSelectedIds:o._params.videosSelectedIds,updateItemCounts:0===r,setID:t},o.appContext)})}),a.reduce(function(e,t){return e.then(t)},e.Promise.resolve()).then(null,function(e){var t=n>1?"ERROR_ADDING_PHOTOS_TO_ALBUM":"ERROR_ADDING_PHOTO_TO_ALBUM";throw o.onError({message:o.intlMessage({intlName:"photo-page-scrappy."+t}),err:e}),e})):s.remote.addPhoto({photoID:o.get("photoID"),isMultiplePhotos:o.get("isMultiplePhotos"),setID:t},o.appContext).then(null,function(e){throw o.onError({message:o.intlMessage({intlName:"photo-page-scrappy.ERROR_ADDING_PHOTO_TO_ALBUM"}),err:e}),e})})},removePhoto:function(t){var o,s=this,r=this.get("multiplePhotosBatchSize"),n=[],i=0,a=[],l=[];if(this.get("isMultiplePhotos"))for(n=this.get("photoID").split(","),i=n.length;n.length>0;)a.push(n.splice(0,r));return this.appContext.getModelRegistry("set-models").then(function(r){if(s.get("isMultiplePhotos")){for(o=0;o<a.length;o++)l.push(r.remote.removePhoto({photoID:a[o].join(","),isMultiplePhotos:!0,numberOfPhotosSelected:s._params.numberOfPhotosSelected,numberOfVideosSelected:s._params.numberOfVideosSelected,updateItemCounts:0===o,setID:t},s.appContext));return e.Promise.all(l).then(null,function(e){var t=i>1?"ERROR_REMOVING_PHOTOS_FROM_ALBUM":"ERROR_REMOVING_PHOTO_FROM_ALBUM";throw s.onError({message:s.intlMessage({intlName:"photo-page-scrappy."+t}),err:e}),e})}return r.remote.removePhoto({photoID:s.get("photoID"),setID:t},s.appContext).then(null,function(e){throw s.onError({message:s.intlMessage({intlName:"photo-page-scrappy.ERROR_REMOVING_PHOTO_FROM_ALBUM"}),err:e}),e})})},createNewAndAddPhoto:function(t,s){var r=this;return this.appContext.getModelRegistry("set-models").then(function(n){return n.remote.create({photoID:r.get("photoID").split(",")[0],title:t,description:s,isMultiplePhotos:r.get("isMultiplePhotos"),numberOfPhotosSelected:r._params.numberOfPhotosSelected,numberOfVideosSelected:r._params.numberOfVideosSelected},r.appContext).then(function(t){var o=[],s=r.get("photoID").split(",");return r.get("isMultiplePhotos")&&(s=s.slice(1)).length>0&&o.push(r.addPhoto(t.getValue("id"))),e.Promise.all(o).then(function(){return t})},function(e){throw r.onError({message:r.intlMessage({intlName:"photo-page-scrappy.ERROR_CREATING_ALBUM"}),err:e}),e}).catch(function(e){o.error("Error handing photo addition after album creation",{err:e})})})},onError:function(e){this.fire("error",e);var t=document.querySelector(".album-selection-errors"),o=document.querySelector(".album-selection-buttons");document.querySelector(".error-message").innerText=e.message,o.classList.add("hide"),t.classList.remove("hide")}})},"@VERSION@",{requires:["flickr-view","album-selection-dialog-view"],optional:["set-models"],langBundles:["common","groups","photo-page-scrappy"]});YUI.add("sub-photo-albums-view",function(t,e){var i=require("hermes-core/flog")(e);t.FlickrView.create(this.name,t.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){this.photoId=t.photoId,this.list=[],this.loading=!1,this.removing={},this.startAmount=6,this.perPage=50,this.displayAmount=this.startAmount,this.addKeyShortcut="down:65,69",void 0!==this.getViewDataFromHistory("displayAmount")&&(this.startAmount=this.getViewDataFromHistory("displayAmount"),this.displayAmount=this.getViewDataFromHistory("displayAmount")),""===this.get("container").get("innerHTML")&&this.setContainerHTML("")},loadState:function(){var e,i=this;return e={photoSetsModel:this.appContext.getModel("photo-sets-models",this.photoId),photoModel:this.appContext.getModel("photo-models",this.photoId)},this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid===this._params.nsid&&(e.personSetsModel=this.appContext.getModel("sets-models",this.appContext.getViewer().nsid,{page:1,perPage:this.appContext.flipper.isFlipped("enable-sets-list-loading-fix")?10:500})),new t.FlickrPromise(e).then(function(e){return t.Object.each(e,function(t,e){i.set(e,t)}),i.loadListData()})},loadListData:function(){var e=this;return this.loading=!0,this.getSets(this.displayAmount).then(function(i){var o,n=e.list,s=[];return e.loading=!1,(s=i||[]).length>e.displayAmount&&(s=s.slice(0,e.displayAmount)),!(function(e,i){var o;return e===i||e.length===i.length&&(o=!0,t.Array.some(e,function(t,e){if(t!==i[e])return o=!1,!0}),o)})(n,s)?(e.list=s,o=!0):o=!1,{listChanged:o}})},getSets:function(e){var i=this.get("photoSetsModel"),o=i.getValue("sets").getList(),n=i.getValue("total");return e>n&&(e=n),o.length<e?i.getListPageByContinuation(e-o.length).then(function(){return i.getValue("sets").getList().slice(0,e)}):t.Promise.resolve(o.slice(0,e))},canViewerRemove:function(t){return this.appContext.getViewer().nsid===this._params.nsid},canViewerAdd:function(){return this.appContext.getViewer().nsid===this._params.nsid},listToJSON:function(){var t=this;return this.list.map(function(e){var i=e.toJSON();return i.isSet=!0,i.canRemove=t.canViewerRemove(e),i})},buildContainer:function(){var e=this.get("photoSetsModel").getValue("total"),i=e>this.displayAmount;this.setContainerWithTemplate("sub-photo-contexts-albums",{empty:0===this.list.length,canAdd:this.canViewerAdd(),contexts:this.listToJSON(),showMore:i,total:e,totalFriendly:t.Number.format(e,{thousandsSeparator:","})})},activate:function(){var t=this,e=this.get("container");return this.canViewerAdd()&&(this.get("photoSetsModel")&&this.registerEventHandler(this.get("photoSetsModel").on("valuesChanged",this.handleListChanges.bind(this))),this.attachKeyEvent(this.addKeyShortcut,function(e){e.preventDefault(),t.showAddDialog()})),this.registerEventHandler(e.on("click",this.handleContainerClick.bind(this))),this},handleListChanges:function(t){this.loading||this.reload()},handleContainerClick:function(t){var e,o,n=this;t.target.ancestor(".remove",!0)?(t.preventDefault(),e=t.target.ancestor("li"),o=e.getAttribute("data-context-id"),this.appContext.getModel("set-models",o).then(function(t){1===t.getValue("photoCount")+t.getValue("videoCount")?n.confirmDeleteAlbum(t).then(function(){n.removeFromContext(o,e)},function(t){i.error("error opening the album deletion warning modal",{err:t})}):n.removeFromContext(o,e)})):t.target.ancestor(".add-to",!0)?(t.preventDefault(),this.showAddDialog()):t.target.ancestor(".view-all-contexts-of-type a",!0)&&(t.preventDefault(),this.showMore())},showMore:function(){this.displayAmount===this.startAmount&&this.startAmount<this.perPage?this.displayAmount=this.perPage:this.displayAmount+=this.perPage,this.setViewDataOnHistory("displayAmount",this.displayAmount),this.reload()},reload:function(){var t=this;this.loadListData().then(function(e){e.listChanged&&t.buildContainer()})},removeFromContext:function(t,e){var i=this,o={photoID:this.photoId,setID:t};this.removing[t]||(this.removing[t]=!0,e.setStyle("opacity","0"),"set-models","removePhoto",this.get("photoSetsModel"),this.appContext.getModelRegistry("set-models").then(function(n){n.remote.removePhoto(o,i.appContext).then(function(e){delete i.removing[t],i.reload()},function(o){throw delete i.removing[t],e.setStyle("opacity","1"),o}).then(null,function(t){throw i.onError({message:this.intlMessage({intlName:"photo-page-scrappy.ERROR_REMOVING_FROM_ALBUM"}),err:t}),t})}))},confirmDeleteAlbum:function(e){var i=this;return new t.Promise(function(e,o){var n;(n=new t.Views.FluidModal({title:i.intlMessage({intlName:"common.CONFIRMATION"}),actionButtonLabel:i.intlMessage({intlName:"photo-page-scrappy.REMOVE_PHOTO_AND_ALBUM"}),htmlMessage:i.intlMessage({intlName:"photo-page-scrappy.WARNING_REMOVE_LAST_PHOTO_FROM_ALBUM"}),appContext:i.appContext,classList:"scrappy-dialog",dismissOnOverlayClick:!1,dismissOnActionClick:!0,actionButtonDisabled:!1,showCancelButton:!0,hideModalOverlay:!1,showCancelX:!0})).on("actionClick",function(t){e(),i.appContext.flapp.get("activeView").backToURL="",i.appContext.flapp.navigate(i.get("photoModel").getValue("url"))}),n.on("cancelClick",function(t){o()}),n.show()})},showAddDialog:function(){this.appContext.flipper.isFlipped("enable-megadroparound")?this.showAddToStuff():this.showAlbumDialog()},showAlbumDialog:function(){var e,i;e=this.appContext.flipper.isFlipped("rename-set-to-album")?new t.Views["set-selection-dialog-view"]({type:"sets",titleSelect:this.intlMessage({intlName:"photo-page-scrappy.ADD_PHOTO_TO_ALBUM"}),titleCreate:this.intlMessage({intlName:"more-menu-view.CREATE_NEW_ALBUM"}),loadingText:this.intlMessage({intlName:"more-menu-view.LOADING_ALBUMS"}),noneText:this.intlMessage({intlName:"more-menu-view.NO_ALBUMS"}),placeholderSearch:this.intlMessage({intlName:"photo-page-scrappy.SEARCH_ALBUMS"}),placeholderTitle:this.intlMessage({intlName:"more-menu-view.ALBUM_TITLE_PLACEHOLDER"}),placeholderDescription:this.intlMessage({intlName:"more-menu-view.DESCRIPTION_PLACEHOLDER"}),buttonTextSwitchCreate:this.intlMessage({intlName:"more-menu-view.CREATE_NEW_ALBUM"}),buttonTextCreate:this.intlMessage({intlName:"more-menu-view.CREATE_ALBUM"}),buttonTextComplete:this.intlMessage({intlName:"photo-page-scrappy.ADD_TO_ALBUM"}),buttonTextCancel:this.intlMessage({intlName:"more-menu-view.BACK_TO_ALBUMS"}),canCreateNew:!0,photoID:this.photoId,appContext:this.appContext}):new t.Views["set-selection-dialog-view"]({type:"sets",titleSelect:this.intlMessage({intlName:"more-menu-view.ADD_PHOTO_TO_SET"}),titleCreate:this.intlMessage({intlName:"more-menu-view.CREATE_NEW_SET"}),loadingText:this.intlMessage({intlName:"more-menu-view.LOADING_SETS"}),noneText:this.intlMessage({intlName:"more-menu-view.NO_SETS"}),placeholderSearch:this.intlMessage({intlName:"more-menu-view.SEARCH_SETS_PLACEHOLDER"}),placeholderTitle:this.intlMessage({intlName:"more-menu-view.SET_TITLE_PLACEHOLDER"}),placeholderDescription:this.intlMessage({intlName:"more-menu-view.ALBUM_TITLE_PLACEHOLDER"}),buttonTextSwitchCreate:this.intlMessage({intlName:"more-menu-view.CREATE_NEW_SET"}),buttonTextCreate:this.intlMessage({intlName:"more-menu-view.CREATE_SET"}),buttonTextComplete:"Add to set",buttonTextCancel:this.intlMessage({intlName:"more-menu-view.BACK_TO_SETS"}),canCreateNew:!0,photoID:this.photoId,appContext:this.appContext}),(i=new t.Views.FluidModal({appContext:this.appContext,title:this.intlMessage({intlName:"photo-page-scrappy.ADD_PHOTO_TO_ALBUM"}),subview:e,actionButtonLabel:this.intlMessage({intlName:"common.DONE"}),classList:"fluid-album-modal photopage scrappy-dialog",showCancelButton:!1,showActionButton:!1,showFooter:!1,dismissOnOverlayClick:!0,width:748,height:514})).on("activated",function(){e.get("container").one(".album-selection-done").on("click",function(){i.close()})}),i.show(),t.rapidTracker.beacon(this.name,"addToSetsClick")},showAddToStuff:function(){new t.CurationHelper(this.appContext,{view:this}).showAddToCuration({photoId:this.photoId,showAlbums:!0,showGalleries:!1,initialTab:"album",useViewportType:!1,containerType:"modal"})},onError:function(e){new t.Views.FluidModal({appContext:this.appContext,title:this.intlMessage({intlName:"common.ERROR"}),message:e.message,actionButtonLabel:this.intlMessage({intlName:"common.OK"}),classList:"scrappy-dialog",showCancelButton:!1,showActionButton:!1,showFooter:!1,dismissOnOverlayClick:!0}).show()}})},"@VERSION@",{requires:["array-extras","flickr-view","flickr-promise","hermes-template-sub-photo-contexts-item","hermes-template-sub-photo-contexts-title-albums","hermes-template-sub-photo-contexts-albums","url-helper","set-selection-dialog-view","fluid-modal-view","add-to-stuff-view","curation-helper"],optional:["photo-sets-models","photo-models","sets-models"],langBundles:["more-menu-view","groups","photo-page-scrappy","common"]});